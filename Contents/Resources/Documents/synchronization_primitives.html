<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=9"/>
	<meta name="generator" content="Doxygen 1.12.0"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>The Haiku Book: Synchronization primitives</title>
	<link href="tabs.css" rel="stylesheet" type="text/css"/>
	<script type="text/javascript" src="jquery.js"></script>
	<script type="text/javascript" src="dynsections.js"></script>
	<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
	<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
	<link href="doxygen.css" rel="stylesheet" type="text/css" />
	<link href="book.css" rel="stylesheet" type="text/css"/>
	</head>
<body>
	<div id="banner">
		<div class="logo">
			<span class="subtitle">
				API Documentation
			</span>
		</div>
	</div>
	<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Synchronization primitives</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In userspace code, there are many way to synchronize threads with each other. Pthreads provide mutexes and condition variables. The Be API provides <a class="el" href="classBLocker.html" title="Semaphore-type class for thread safety.">BLocker</a>. There are also atomic functions and a few other options, on which many solutions can be built.</p>
<p>The kernel side is a bit more restricted, in particular when it comes to synchronizing between interrupt handlers and other parts of the code. This is because of two reasons: first of all, interrupt are a low level mechanism of the CPU, and while interrupt handling code is running, the normal operations of the kernel are interrupted (as the name implies). So, normal scheduling will not take place. Secondly, interrupts are not allowed to be blocked to wait on anything. This rules out the use of critical sections in the traditional sense, where the interrupt code may want to wait for an userspace thread to complete.</p>
<p>As a result, the way synchronization is handled in the kernel is a bit different. The basic primitives available are: spinlocks, atomic operations, semaphores, and condition variables.</p>
<h1><a class="anchor" id="spinlocks"></a>
Spinlocks</h1>
<p>A spinlock is a busy wait: it will run a loop, testing over and over for a condition to become true. On a single task system, that would not work, the CPU would be busy forever, and the condition would never change. But, Haiku is a multitask system, and so the condition can be changed, either because of code running on another CPU core, or code running in an interrupt handler (which can interrupt the thread that's running the spinlock).</p>
<p>The downside of spinlocks is that they keep the CPU busy. Not only this increases power usage, it also prevents using the CPU for something else (maybe another thread would like to run while this one is waiting). As a result, they are used only for very short waits, and always with a timeout to make sure they don't lock up a CPU core forever or even for an unreasonably long time (that will result in a panic and a trip to the kernel debugger).</p>
<h1><a class="anchor" id="atomic_ops"></a>
Atomic operations</h1>
<p>Atomic operations are defined in the <a class="el" href="group__support.html">Support Kit</a>. However, they are actually implemented using only CPU instructions, and no operating system support. This means they are available for use in Kernel code as well.</p>
<p>They are used as a building block for higher level primitives, but are also occasionally useful for simple synchronization needs or things like event counters. Since they are implemented at the CPU level, they are quite fast.</p>
<p>Atomic operations are not blocking, but they guarantee that an operation will complete before an interrupt happens or another CPU core accesses the same memory.</p>
<h1><a class="anchor" id="semaphores"></a>
Semaphores</h1>
<p>Semaphores are the historical way to signal events in BeOS and Haiku. A semaphore has a counter that can be incremented (release_sem) and decremented (acquire_sem). The counter is not allowed to go below 0, if a thread attempts to acquire an empty semaphore, it will be blocked until someone else releases it.</p>
<p>Seaphores can be used to implement mutexes: by creating a semaphore with a count of 1, threads can enter the critical section by acquiring, and exit it by releasing the semaphore. Additional checks can be added to make sure that only threads in the critical section can release the semaphore in this case.</p>
<p>But semaphores are also useful in other cases. For example, they can be used for an interupt handler to wake up a thread. In that case, the interrupt handler always releases the semaphore (when an interrupt happens) and the thread always acquires it. Releasing a semaphore is never a blocking operation, so there is no risk of blocking an interrupt handler. This setup makes sure the thread is waken up exactly one time per event the interrupt needs to handle.</p>
<p>Finally, semaphores are identified by an unique number, which can be shared between kernel and userspace. As a result, they can be used to sycnhronize directly between userspace and kernelspace threads, or even directly from interrupt handlers to userspace threads. The downside of this is that there is a limited number of semaphores, and if too much code uses them, or if there is a leak in some code creating and never destroing semaphores, this may end up blocking the system completely.</p>
<h1><a class="anchor" id="condition_variables"></a>
Condition Variables</h1>
<p>A more recent addition to Haiku synchronization primitives is condition variables. They allow a thread to wait for a specific condition, which is notified by another thread. This is similar to the use of semaphores outlined above, but provides an easier way to handle race conditions, spurious wakeups, and so on. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
  <hr class="footer"/><address class="footer"><small>
    The Haiku Book pre-R1 - Synchronization primitives<br />
    Generated on Sat May 24 2025 23:12:17 by <a href="http://www.doxygen.org/index.html">Doxygen</a> 1.12.0
  </small></address>
</body>
</html>
